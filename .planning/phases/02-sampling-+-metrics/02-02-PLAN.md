---
phase: 02-sampling-+-metrics
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/hooks/usePlaylistAnalysis.ts
  - src/components/SampleControls.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can select a sample duration preset and trigger sampling."
    - "User can set a VOD start offset or a live anchor for the sample window."
    - "User can choose a rendition for sampling when multiple variants exist."
  artifacts:
    - path: "src/components/SampleControls.tsx"
      provides: "Sample duration, offset/anchor, and rendition selection UI"
    - path: "src/hooks/usePlaylistAnalysis.ts"
      provides: "Sampling state and runSample/retrySample actions"
    - path: "src/App.tsx"
      provides: "Phase 2 layout with sampling controls"
  key_links:
    - from: "src/components/SampleControls.tsx"
      to: "src/hooks/usePlaylistAnalysis.ts"
      via: "onRunSample and config setters"
      pattern: "onRunSample"
    - from: "src/hooks/usePlaylistAnalysis.ts"
      to: "src/analysis/sampling/analyzeSample.ts"
      via: "runSample"
      pattern: "analyzeSample"
---

<objective>
Wire sampling controls and state into the app so users can configure and run a sample window.

Purpose: Expose Phase 2 sampling configuration in the UI and connect it to the analysis core.
Output: SampleControls component plus updated analysis hook and Phase 2 header copy.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/hooks/usePlaylistAnalysis.ts
@src/components/InputPanel.tsx
@src/components/LadderTable.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend analysis hook with sampling state</name>
  <files>src/hooks/usePlaylistAnalysis.ts</files>
  <action>
Augment the hook to manage sampling state alongside playlist analysis:
- Track lastPlaylistUrl, parsed manifest, and ladder variants from the analysis step so sampling can reuse them without re-fetching the master playlist.
- Add sampleConfig state with duration preset (seconds), startOffsetSeconds, liveAnchorSeconds, and selectedRenditionIndex (default to the top video variant).
- Add sampleState with status: idle/loading/success/error, plus result/error/partialResult fields.
- Implement runSample that calls analyzeSample with the stored manifest and base URL; include selected rendition index and current SampleConfig. For file inputs, allow base URL to be undefined and rely on diagnostics.
- Implement retrySample that reuses the last config and selected rendition.

Ensure analyze() still works as before, and avoid adding new dependencies.
  </action>
  <verify>npm run build</verify>
  <done>Hook exposes sampling state and actions without breaking Phase 1 analysis flow.</done>
</task>

<task type="auto">
  <name>Task 2: Add sampling controls to the UI</name>
  <files>
src/components/SampleControls.tsx
src/App.tsx
  </files>
  <action>
Create a SampleControls component that follows Phase 2 decisions:
- Render duration presets as buttons (no free-entry field). Use 15, 30, 60, and 120 seconds unless a better preset list already exists.
- Show a numeric input for VOD startOffsetSeconds (seconds) when streamType is vod.
- Show a numeric input for liveAnchorSeconds (seconds behind live edge) when streamType is live.
- Provide a rendition selector (dropdown) listing video variants by bitrate + resolution; use selectedRenditionIndex from the hook.
- Include a "Run sample" button and a disabled state when analysis is not successful or a sample is already running.

Update App.tsx to:
- Change the header copy to Phase 2 (Sampling + Metrics) title/subtitle.
- Render SampleControls in the Results panel above the metrics sections, wired to the hook state/actions.
- Pass classification/ladder info to SampleControls to decide which fields to show.
  </action>
  <verify>npm run build</verify>
  <done>Users can configure duration/offset/anchor and trigger sampling from the Results panel.</done>
</task>

</tasks>

<verification>
npm run build
</verification>

<success_criteria>
- Sampling controls reflect stream type (vod vs live) and ladder variants.
- Running a sample triggers hook state changes without breaking existing results.
</success_criteria>

<output>
After completion, create `.planning/phases/02-sampling-+-metrics/02-02-SUMMARY.md`
</output>
