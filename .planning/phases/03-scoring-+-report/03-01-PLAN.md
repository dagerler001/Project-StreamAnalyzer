---
phase: 03-scoring-+-report
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/scoring.ts
  - src/scoring/policies/policyRegistry.ts
  - src/scoring/policies/basePolicy.ts
  - src/scoring/policies/appleHLS.ts
  - src/scoring/policies/googleVP9.ts
  - src/scoring/policies/generic.ts
autonomous: true

must_haves:
  truths:
    - "Policy profiles are defined and selectable (Apple HLS, Google VP9, Generic)"
    - "Scoring types exist for rules, results, and recommendations"
    - "Policy registry provides access to all available policies"
  artifacts:
    - path: "src/types/scoring.ts"
      provides: "TypeScript types for scoring system"
      exports:
        - "ScoringPolicy"
        - "RuleConfig"
        - "ScoringRule"
        - "RuleResult"
        - "ScoreResult"
        - "Recommendation"
    - path: "src/scoring/policies/policyRegistry.ts"
      provides: "Policy registry with all available policies"
      exports: ["getAllPolicies", "getPolicyById"]
    - path: "src/scoring/policies/appleHLS.ts"
      provides: "Apple HLS best practices policy"
    - path: "src/scoring/policies/googleVP9.ts"
      provides: "Google VP9 recommendations policy"
    - path: "src/scoring/policies/generic.ts"
      provides: "Generic/balanced policy"
  key_links:
    - from: "src/scoring/policies/policyRegistry.ts"
      to: "policy files"
      via: "imports"
    - from: "all policy files"
      to: "src/types/scoring.ts"
      via: "type imports"
---

<objective>
Create the scoring type system and policy profile infrastructure for the ABR ladder scoring engine.

Purpose: Establish the foundation for explainable scoring by defining types, interfaces, and three initial policy profiles (Apple HLS, Google VP9, Generic) that configure which rules apply and their weights.

Output: Complete type definitions and policy registry with three working policy profiles.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scoring-+-report/03-RESEARCH.md
@src/types/analysis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define scoring domain types</name>
  <files>src/types/scoring.ts</files>
  <action>
Create comprehensive TypeScript types for the scoring system in `src/types/scoring.ts`:

**Core Types:**
- `ScoringPolicy`: Policy profile with id, name, description, rules array
- `RuleConfig`: Rule configuration with ruleId, enabled, weight (0-1), optional params
- `RuleCategory`: Union type 'ladder' | 'codec' | 'segment' | 'metadata'
- `AnalysisContext`: Context passed to rules containing ladder, classification, sampleResult

**Rule Types:**
- `ScoringRule`: Interface with id, name, category, check function returning RuleResult
- `RuleResult`: Result with passed (boolean), score (0-100), warnings array, recommendations array
- `Warning`: Severity ('error' | 'warning' | 'info'), message, hint

**Result Types:**
- `ScoreBreakdown`: Overall score (0-100) + categories (ladder, codec, segment, metadata)
- `CategoryScore`: Score, maxScore, rules array (RuleScore[])
- `RuleScore`: ruleId, score, maxScore, passed, reason (human-readable), recommendation
- `ScoreResult`: Overall score + breakdown + warnings + recommendations + originalLadder

**Recommendation Types:**
- `Recommendation`: id, type ('add_variant' | 'remove_variant' | 'modify_variant' | 'general'), severity, message, details, optional variant info
- `VariantChange`: index, current (Partial&lt;LadderVariant&gt;), suggested (Partial&lt;LadderVariant&gt;)

Import `LadderResult`, `PlaylistClassification`, `SampleResult` from `./analysis`.

Follow patterns from 03-RESEARCH.md Architecture Patterns section. All scores normalized 0-100.
  </action>
  <verify>npm run build compiles without TypeScript errors</verify>
  <done>Type definitions exist, properly import from analysis.ts, no compilation errors</done>
</task>

<task type="auto">
  <name>Task 2: Create policy profiles and registry</name>
  <files>
    src/scoring/policies/basePolicy.ts
    src/scoring/policies/appleHLS.ts
    src/scoring/policies/googleVP9.ts
    src/scoring/policies/generic.ts
    src/scoring/policies/policyRegistry.ts
  </files>
  <action>
Create the policy infrastructure:

**src/scoring/policies/basePolicy.ts:**
- Export base policy interface/type re-exports from scoring.ts for convenience

**src/scoring/policies/appleHLS.ts:**
- Export `appleHlsPolicy: ScoringPolicy` with:
  - id: 'apple-hls', name: 'Apple HLS Best Practices'
  - description: 'Optimized for Apple devices following HLS Authoring Specification'
  - Rules: bitrate-spacing (0.15), resolution-ladder (0.20), codec-compatibility (0.15), audio-codec (0.10), segment-duration (0.15), keyframe-alignment (0.15), bandwidth-attributes (0.10)

**src/scoring/policies/googleVP9.ts:**
- Export `googleVP9Policy: ScoringPolicy` with:
  - id: 'google-vp9', name: 'Google VP9 Recommendations'
  - description: 'Optimized for VP9 codec following Google encoding guidelines'
  - Same rules as Apple but codec-compatibility weight 0.20 with params { preferVP9: true }

**src/scoring/policies/generic.ts:**
- Export `genericPolicy: ScoringPolicy` with:
  - id: 'generic', name: 'Generic/Balanced'
  - description: 'Balanced scoring for general-purpose streaming'
  - Equal weights (0.14-0.15) across all rules

**src/scoring/policies/policyRegistry.ts:**
- Import all policies
- Export `getAllPolicies(): ScoringPolicy[]` returning [appleHlsPolicy, googleVP9Policy, genericPolicy]
- Export `getPolicyById(id: string): ScoringPolicy | undefined`

Use exact rule IDs: 'bitrate-spacing', 'resolution-ladder', 'codec-compatibility', 'audio-codec', 'segment-duration', 'keyframe-alignment', 'bandwidth-attributes'.
  </action>
  <verify>npm run build compiles without errors; console.log(getAllPolicies()) returns 3 policies</verify>
  <done>Three policy profiles defined, registry exports work, TypeScript compiles</done>
</task>

</tasks>

<verification>
- [ ] Type definitions complete and exported
- [ ] Three policy profiles (Apple HLS, Google VP9, Generic) defined with correct weights
- [ ] Policy registry provides getAllPolicies() and getPolicyById()
- [ ] All files compile without TypeScript errors
- [ ] Types properly reference existing Analysis types
</verification>

<success_criteria>
- Scoring types exist in src/types/scoring.ts
- Policy profiles defined for Apple HLS, Google VP9, and Generic
- Policy registry provides access to all policies
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-scoring-+-report/03-01-SUMMARY.md`
</output>
