---
phase: 01-ingest-+-rfc-validation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/analysis/playlist/validatePlaylist.ts
  - src/analysis/playlist/classifyPlaylist.ts
  - src/analysis/ladder/codecLabels.ts
  - src/analysis/ladder/extractLadder.ts
  - src/analysis/resolver/mockCdnMap.ts
  - src/analysis/resolver/resolveInput.ts
autonomous: true
must_haves:
  truths:
    - "Validation returns structured issues with severity and fix hints when playlist rules are violated."
    - "Classification resolves playlist type (master/media/unknown) and stream type (live/vod)."
    - "Ladder extraction returns audio/video variants sorted by bitrate with friendly codec labels."
    - "ID resolution returns a URL for known IDs and a typed error for unknown IDs."
  artifacts:
    - path: "src/analysis/playlist/validatePlaylist.ts"
      provides: "RFC 8216 validation issues"
    - path: "src/analysis/playlist/classifyPlaylist.ts"
      provides: "Master/media + live/VOD classification"
    - path: "src/analysis/ladder/extractLadder.ts"
      provides: "ABR ladder extraction"
    - path: "src/analysis/resolver/resolveInput.ts"
      provides: "Channel/VOD ID to URL resolver"
  key_links:
    - from: "src/analysis/playlist/classifyPlaylist.ts"
      to: "src/analysis/ladder/extractLadder.ts"
      via: "playlistType gate"
      pattern: "playlistType"
    - from: "src/analysis/resolver/resolveInput.ts"
      to: "src/analysis/resolver/mockCdnMap.ts"
      via: "ID lookup"
      pattern: "MOCK_CDN_MAP"
---

<objective>
Implement RFC validation, playlist classification, ladder extraction, and input resolution.

Purpose: Provide the analysis outputs that surface validation, classification, and ladder results to users.
Output: Typed validation/classification/ladder utilities plus a mock ID resolver.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ingest-+-rfc-validation/01-CONTEXT.md
@.planning/phases/01-ingest-+-rfc-validation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement validation rules and playlist classification</name>
  <files>src/analysis/playlist/validatePlaylist.ts, src/analysis/playlist/classifyPlaylist.ts</files>
  <action>
    Implement RFC-focused validation rules with severities and fix hints:
    - EXTM3U must be the first line (error with hint).
    - Master/media tag mixing is invalid (error when both master and media tags appear).
    - Master playlists must have EXT-X-STREAM-INF with a following URI (error when missing).
    - Media playlists should include EXTINF for segments (warning when missing or zero).
    - Missing EXT-X-VERSION yields an info-level warning.
    Add classification logic:
    - playlistType: "master" when manifest.playlists exists; "media" when segments exist; "unknown" otherwise.
    - streamType: "vod" when ENDLIST present or PLAYLIST-TYPE=VOD; "live" otherwise (EVENT treated as live).
  </action>
  <verify>npm run build</verify>
  <done>Validation returns structured issues and classification resolves master/media + live/VOD.</done>
</task>

<task type="auto">
  <name>Task 2: Implement ladder extraction, codec labels, and ID resolver</name>
  <files>src/analysis/ladder/codecLabels.ts, src/analysis/ladder/extractLadder.ts, src/analysis/resolver/mockCdnMap.ts, src/analysis/resolver/resolveInput.ts</files>
  <action>
    Add ladder extraction for master playlists:
    - Build video variants from manifest.playlists attributes (BANDWIDTH, AVERAGE-BANDWIDTH, RESOLUTION, CODECS, FRAME-RATE).
    - Build audio variants from manifest.mediaGroups.AUDIO entries with associated codecs where available.
    - Provide friendly codec labels (avc1->H.264, hvc1/hev1->H.265, av01->AV1, mp4a->AAC, ec-3->E-AC-3, ac-3->AC-3).
    - Sort variants by descending bitrate (fallback to averageBandwidth when needed).
    Create a mock CDN map and resolver that maps channel/VOD IDs to known URLs; return a typed error if unknown.
  </action>
  <verify>npm run build</verify>
  <done>Ladder extraction returns sorted audio/video variants and ID resolver returns URLs or typed errors.</done>
</task>

</tasks>

<verification>
`npm run build` completes without errors.
</verification>

<success_criteria>
Validation, classification, ladder extraction, and ID resolution compile and return expected outputs for the UI.
</success_criteria>

<output>
After completion, create `.planning/phases/01-ingest-+-rfc-validation/01-03-SUMMARY.md`
</output>
