---
phase: 01-ingest-+-rfc-validation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - package-lock.json
  - src/types/analysis.ts
  - src/analysis/playlist/text.ts
  - src/analysis/playlist/parseM3U8.ts
  - src/analysis/playlist/validatePlaylist.ts
  - src/analysis/playlist/classifyPlaylist.ts
  - src/analysis/ladder/codecLabels.ts
  - src/analysis/ladder/extractLadder.ts
  - src/analysis/resolver/mockCdnMap.ts
  - src/analysis/resolver/resolveInput.ts
autonomous: true
must_haves:
  truths:
    - "Parsed playlist text yields a manifest plus normalized lines for validation and analysis."
    - "Validation returns structured issues with severity and fix hints for RFC rule violations."
    - "Classification reports playlist type (master/media/unknown) and stream type (live/vod)."
    - "Ladder extraction returns sorted audio/video variants with bitrate, resolution, and codec labels."
    - "Resolver maps channel/VOD IDs to URLs or returns a typed error when unknown."
  artifacts:
    - path: "src/analysis/playlist/parseM3U8.ts"
      provides: "M3U8 parsing wrapper"
    - path: "src/analysis/playlist/validatePlaylist.ts"
      provides: "RFC 8216 validation issues"
    - path: "src/analysis/playlist/classifyPlaylist.ts"
      provides: "Master/variant + live/VOD classification"
    - path: "src/analysis/ladder/extractLadder.ts"
      provides: "ABR ladder extraction"
    - path: "src/analysis/resolver/resolveInput.ts"
      provides: "Channel/VOD ID to URL resolver"
  key_links:
    - from: "src/analysis/playlist/parseM3U8.ts"
      to: "src/analysis/playlist/validatePlaylist.ts"
      via: "manifest input"
      pattern: "validatePlaylist"
    - from: "src/analysis/playlist/classifyPlaylist.ts"
      to: "src/analysis/ladder/extractLadder.ts"
      via: "playlistType gate"
      pattern: "playlistType"
---

<objective>
Implement the Phase 1 analysis core: parsing, validation, classification, and ladder extraction.

Purpose: Provide RFC-compliant analysis primitives for ingest inputs.
Output: Typed analysis utilities that return validation issues, playlist classification, and ladder variants.
Scope note: This plan spans multiple analysis modules (types, parsing, validation, ladder, resolver); file count reflects the modular split.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ingest-+-rfc-validation/01-CONTEXT.md
@.planning/phases/01-ingest-+-rfc-validation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analysis types and M3U8 parsing wrapper</name>
  <files>package.json, package-lock.json, src/types/analysis.ts, src/analysis/playlist/text.ts, src/analysis/playlist/parseM3U8.ts</files>
  <action>
    Install `m3u8-parser` and add analysis domain types for:
    - ValidationIssue (severity, message, hint, tag?, line?)
    - PlaylistClassification (playlistType, streamType)
    - LadderVariant (bitrate, averageBandwidth?, resolution?, codecs, frameRate?)
    - AnalysisResult (validation, classification, ladder, reliable flag)
    Create a small text helper to normalize playlist text (strip UTF-8 BOM, preserve line numbers) and
    a parseM3U8 wrapper that returns the manifest plus normalized raw lines for validation.
  </action>
  <verify>npm run build</verify>
  <done>Parsing wrapper returns manifest + lines and types compile without TS errors.</done>
</task>

<task type="auto">
  <name>Task 2: Implement validation, classification, and ladder extraction</name>
  <files>src/analysis/playlist/validatePlaylist.ts, src/analysis/playlist/classifyPlaylist.ts, src/analysis/ladder/codecLabels.ts, src/analysis/ladder/extractLadder.ts, src/analysis/resolver/mockCdnMap.ts, src/analysis/resolver/resolveInput.ts</files>
  <action>
    Implement RFC-focused validation rules with severities and fix hints:
    - EXTM3U must be the first line (error with hint).
    - Master/media tag mixing is invalid (error when both master and media tags appear).
    - Master playlists must have EXT-X-STREAM-INF with a following URI (error when missing).
    - Media playlists should include EXTINF for segments (warning when missing or zero).
    - Missing EXT-X-VERSION yields an info-level warning.
    Add classification logic:
    - playlistType: "master" when manifest.playlists exists; "media" when segments exist; "unknown" otherwise.
    - streamType: "vod" when ENDLIST present or PLAYLIST-TYPE=VOD; "live" otherwise (EVENT treated as live).
    Add ladder extraction for master playlists:
    - Build video variants from manifest.playlists attributes (BANDWIDTH, AVERAGE-BANDWIDTH, RESOLUTION, CODECS, FRAME-RATE).
    - Build audio variants from manifest.mediaGroups.AUDIO entries with associated codecs where available.
    - Provide friendly codec labels (avc1->H.264, hvc1/hev1->H.265, av01->AV1, mp4a->AAC, ec-3->E-AC-3, ac-3->AC-3).
    - Sort variants by descending bitrate (fallback to averageBandwidth when needed).
    Create a mock CDN map and resolver that maps channel/VOD IDs to known URLs; return a typed error if unknown.
  </action>
  <verify>npm run build</verify>
  <done>Validation returns structured issues, classification resolves master/media + live/VOD, and ladder extraction returns sorted audio/video variants.</done>
</task>

</tasks>

<verification>
`npm run build` completes without errors.
</verification>

<success_criteria>
Core analysis utilities compile and can be called from the UI to deliver Phase 1 outputs.
</success_criteria>

<output>
After completion, create `.planning/phases/01-ingest-+-rfc-validation/01-02-SUMMARY.md`
</output>
